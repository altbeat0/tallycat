<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TallyCat">
  <link rel="apple-touch-icon" href="catto.ico">
  <title>TallyCat</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
  <style>
    /* GENERAL STYLES & RESET */
    html, body {
      overscroll-behavior: none;
      -webkit-overflow-scrolling: auto;
      background-color: #1a1a1a;
      color: #ffffff;
      padding: 10px;
      margin: 0px;
      font-family: system-ui, -apple-system, sans-serif;
    }
    *, button, input {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    /* CONTAINER */
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    /* HEADER & PROGRESS */
    .attendance-header {
                display: flex;
        justify-content: center;
        align-items: flex-end; /* Aligns items by their bottom */
        gap: 20px;
        margin-bottom: 20px;
    }
    .attendance-header h2 {
      font-size: 40px;
      font-weight: 400;
      margin-top: 15px;
    }
    .overall-progress {
      width: 75px;
      height: 75px;
      position: relative;
    }
    .progress-circle {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .progress-value {
      position: absolute;
      font-size: 16px;
      font-weight: 500;
    }
    /* TALLY */
    .attendance-tally {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 12px;
      font-size: 18px;
      color: #ffffff;
    }
    .attendance-tally-line {
      text-align: center;
      font-size: 85%;
      color: #ffffff98;
      line-height: 1.5;
      margin-bottom: 12px;
    }
    /* BUTTONS */
    .action-buttons, .attendance-controls, .medical-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .btn, .attendance-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 20px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: opacity 0.2s;
      touch-action: manipulation;
    }
    .btn:hover, .attendance-btn:hover {
      opacity: 0.9;
    }
    .btn-present { background-color: #22c55e; }
    .btn-absent { background-color: #ef4444; }
    .btn-medical { background-color: #d6a30a; }
    /* SUBJECT CARD */
    .subject-card {
      background-color: #27272a;
      border-radius: 12px;
      padding: 15px 15px 5px 15px;
      margin-bottom: 15px;
    }
    .subject-title {
      font-size: 20px;
      font-weight: 400;
      margin-bottom: 15px;
      cursor: pointer;
    }
    .subject-stats {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .stat-label {
      color: #a1a1aa;
      font-size: 14px;
    }
    /* EDIT BUTTON */
    .edit-btn {
      background-color: #4b55637d;
      border: none;
      cursor: pointer;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      user-select: none;
    }
    .attendance-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-start;
    }
    .attendance-btn.present { background-color: #22c55e; }
    .attendance-btn.absent { background-color: #ef4444; }
    .subject-progress {
      width: 60px;
      height: 0;
      margin-left: auto;
      margin-top: -30px;
      position: relative;
    }
    .username {
      color: #a1a1aa;
      font-size: 14px;
      margin-top: 20px;
      text-align: right;
    }
    /* MEDICAL SECTION */
    .medical-dates {
      margin-top: 0;
      color: #a1a1aa;
      font-size: 14px;
    }
    .medical-dates ul {
      list-style: none;
      margin-top: 0;
    }
    .medical-dates li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid #444444bc;
    }
    .medical-dates li:last-child {
      border-bottom: none;
    }
    .medical-dates li span {
      font-size: 16px;
    }
    .delete-date {
      background: none;
      border: none;
      color: #ef4444;
      cursor: pointer;
      padding: 2px 8px;
      font-size: 18px;
    }
    .delete-date:hover { opacity: 0.8; }
    .medical-toggle-btn {
      background-color: #d6a30a;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      display: block;
      text-transform: lowercase;
      float: right;
      margin: 0 0 10px 0;
      font-size: 14px;
    }
    .reset-btn {
      background-color: #007bffc5;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      text-transform: lowercase;
      float: left;
      margin: 0 0 10px 0;
    }
    .reset-btn:hover { opacity: 0.9; }
    .medical-dates-container {
      transition: all 0.3s ease;
      margin-top: 10px;
      background-color: #1e1e1e;
      padding: 10px;
      border-radius: 8px;
    }
    #medicalAttendanceMessage {
      margin-top: 0;
      font-size: 16px;
      font-weight: 500;
      text-align: center;
      padding: 0 30px 20px;
      color: #b0b0bc;
    }
    .medical-input {
      padding: 5px;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      justify-content: center;
    }
    .medical-input input[type="date"] {
      padding: 5px 12px;
      border: 1px solid #444;
      border-radius: 4px;
      background-color: #27272a;
      color: #ffffff;
      font-size: 14px;
      text-align: center;
      margin-bottom: 10px;
    }
    .medical-input button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      background-color: #d6a30ac4;
      color: white;
      cursor: pointer;
      text-transform: lowercase;
      margin-bottom: 10px;
    }
    .marking-status {
      color: #22c55e;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s;
      margin-left: 10px;
    }
    .marking-status.visible { opacity: 1; }
    .marking-status .tick { margin-right: 4px; }
    /* FOOTER */
    .footer {
      text-align: center;
      margin: 20px;
      padding-top: 10px;
      border-top: 1px solid #444;
      font-size: 14px;
    }
    .footer .note { margin-bottom: 5px; color: #c5c5c5ac; line-height: 1.5; }
    .footer .developer { color: #7a7a8097; }
    @media (display-mode: standalone) { body { padding-top: 40px; } }
    /* MODALS */
    .modal {
                display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        backdrop-filter: blur(10px); /* Adds a blur effect */
        background-color: rgba(0, 0, 0, 0.5); /* Dark translucent overlay */
        align-items: center;
        justify-content: center;
    }
    .modal-content {
                background: rgba(34, 34, 34, 0.9); /* Slightly transparent background */
        backdrop-filter: blur(10px); /* Adds a frosted glass effect */
        padding: 20px;
        width: 85%;
        max-width: 400px;
        border-radius: 12px;
        color: white;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }
    .modal-content input {
      width: 100%;
      padding: 10px;
      font-size: 18px;
      margin-bottom: 10px;
      background-color: #27272a;
      border: 1px solid #444;
      border-radius: 4px;
      color: white;
    }
    .modal-content button {
                padding: 10px 16px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        margin: 10px 5px;
        transition: all 0.2s ease;
    }
    .modal-content .cancel-btn {
      background-color: #444;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 5px;
      transition: background 0.2s;
    }
    .modal-content .cancel-btn:hover {
      background-color: #666;
    }
    .modal-content .ok-btn {   background-color: #22c55e; color: white;}
    .save-btn {
      background-color: #4ade80c5;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      text-transform: lowercase;
      display: block;
      margin: 0 0 10px 0;
    }
    .save-btn:hover { opacity: 0.9; }
    /* SETTINGS MODAL */
    .settings-btn {
  position: absolute;
  top: 10px;
  left: 10px;
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #a1a1aa;
  padding: 8px;
}

    .settings-content {
      max-width: 400px;
      width: 90%;
      padding: 0 18px 16px 18px;
      position: relative;
    }
    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px 0 18px;
      margin-bottom: 4px;
    }
    .settings-title {
      font-size: 22px;
      font-weight: 400;
      text-transform: lowercase;
      letter-spacing: 1px;
    }
    .close-settings-btn {
      background: #27272a;
      color: #fff;
      font-size: 22px;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      cursor: pointer;
      padding: 0;
      box-sizing: border-box;
    }
    .close-settings-btn:hover {
      background: #333;
    }
    .settings-section {
      margin: 14px 12px 0 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid #444;
    }
    .settings-section:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    .settings-section-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .settings-section-title {
      font-size: 17px;
      font-weight: 500;
      text-align: left;
      text-transform: lowercase;
      margin: 0;
    }
    .section-action-btn {
      margin: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0 18px;
      font-size: 15px;
      border-radius: 16px;
      height: 36px;
      min-width: 90px;
      border: none;
      box-sizing: border-box;
      font-weight: 500;
      transition: background 0.2s, color 0.2s;
    }
    .apply-btn {
      background-color: #3b82f6;
      color: white;
      border: none;
    }
    .reset-all-btn {
      background-color: #ef4444;
      color: white;
      border: none;
    }
    .subject-control {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    #subjectCount {
      font-size: 22px;
      min-width: 30px;
      text-align: center;
    }
    .warning-text {
      color: #ef4444;
      margin-bottom: 12px;
      text-align: center;
      font-size: 14px;
    }
    .btn, .attendance-btn, .control-btn {
        transition: transform var(--transition-speed), opacity var(--transition-speed);
        }
    .btn:hover, .attendance-btn:hover, .control-btn:hover {
    transform: scale(1.03);
    opacity: 0.9;
    }


    .apply-btn { background-color: #3b82f6; color: white; }
    .reset-all-btn { background-color: #ef4444; color: white; }
    .close-settings-btn { background-color: #27272a; color: white; margin-top: px; }
    .warning-text { color: #ef4444; margin-bottom: 15px; text-align: center; font-size: 14px; }
    .confirm-content { max-width: 350px; }
    .confirm-content h3 { margin-bottom: 15px; font-size: 20px; text-align: center; }
    .confirm-content p { margin-bottom: 20px; text-align: center; }
    .confirm-buttons { display: flex; justify-content: space-between; }
    .confirm-btn {   background-color: #ef4444; color: white;}
    button:hover { opacity: 0.8;}
    .apply-btn.disabled {
      background-color: #444 !important;
      color: #bbb !important;
      cursor: not-allowed !important;
      opacity: 0.7;
    }
    #applyConfirmModal .apply-btn {
      background-color: #3b82f6;
      color: white;
    }
    @media (max-width: 400px) {
      .settings-content {
        padding-left: 8vw;
        padding-right: 8vw;
      }
      .settings-header {
        padding-left: 8vw;
        padding-right: 8vw;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <button id="settingsBtn" class="settings-btn">‚öôÔ∏è</button>
    <div class="attendance-header">
      <h2>attendance:</h2>
      <div class="overall-progress progress-circle">
        <canvas id="overallChart"></canvas>
        <span class="progress-value">0%</span>
      </div>
    </div>
    <!-- Tally Display -->
    <div class="attendance-tally">
      <span id="totalAttended">total attended: 0</span>
      <span id="totalLectures">total lectures: 0</span>
    </div>
    <div class="attendance-tally-line"><span id="attendanceHint" style="display:block;"></span></div>
    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="btn btn-present" onclick="markAllPresent()">all present</button>
      <button class="btn btn-absent" onclick="markAllAbsent()">all absent</button>
      <button class="btn btn-medical" onclick="markMedical()">mark for medical</button>
    </div>
    <!-- Subjects Section -->
    <div class="subjects">
      <div class="subject-card" data-subject="subject-1">
        <h3 class="subject-title" onclick="editSubjectName(this)">subject 1</h3>
        <div class="subject-stats">
          <div class="stat-item">
            <span class="stat-label">attended:</span>
            <span class="attended">0</span>
            <button class="edit-btn" onclick="openNumberPicker(this, 'attended')">‚úé</button>
          </div>
          <div class="stat-item">
            <span class="stat-label">total:</span>
            <span class="total">0</span>
            <button class="edit-btn" onclick="openNumberPicker(this, 'total')">‚úé</button>
          </div>
          <div class="subject-progress progress-circle">
            <canvas class="subject-chart"></canvas>
            <span class="progress-value">0%</span>
          </div>
        </div>
        <div class="attendance-controls">
          <button class="attendance-btn present" onclick="markAttendance(this, 'present')">present</button>
          <button class="attendance-btn absent" onclick="markAttendance(this, 'absent')">absent</button>
          <span class="marking-status"><span class="tick">‚úì</span>marked</span>
        </div>
      </div>
      <div class="subject-card" data-subject="subject-2">
        <h3 class="subject-title" onclick="editSubjectName(this)">subject 2</h3>
        <div class="subject-stats">
          <div class="stat-item">
            <span class="stat-label">attended:</span>
            <span class="attended">0</span>
            <button class="edit-btn" onclick="openNumberPicker(this, 'attended')">‚úé</button>
          </div>
          <div class="stat-item">
            <span class="stat-label">total:</span>
            <span class="total">0</span>
            <button class="edit-btn" onclick="openNumberPicker(this, 'total')">‚úé</button>
          </div>
          <div class="subject-progress progress-circle">
            <canvas class="subject-chart"></canvas>
            <span class="progress-value">0%</span>
          </div>
        </div>
        <div class="attendance-controls">
          <button class="attendance-btn present" onclick="markAttendance(this, 'present')">present</button>
          <button class="attendance-btn absent" onclick="markAttendance(this, 'absent')">absent</button>
          <span class="marking-status"><span class="tick">‚úì</span>marked</span>
        </div>
      </div>
      <div class="subject-card" data-subject="subject-3">
        <h3 class="subject-title" onclick="editSubjectName(this)">subject 3</h3>
        <div class="subject-stats">
          <div class="stat-item">
            <span class="stat-label">attended:</span>
            <span class="attended">0</span>
            <button class="edit-btn" onclick="openNumberPicker(this, 'attended')">‚úé</button>
          </div>
          <div class="stat-item">
            <span class="stat-label">total:</span>
            <span class="total">0</span>
            <button class="edit-btn" onclick="openNumberPicker(this, 'total')">‚úé</button>
          </div>
          <div class="subject-progress progress-circle">
            <canvas class="subject-chart"></canvas>
            <span class="progress-value">0%</span>
          </div>
        </div>
        <div class="attendance-controls">
          <button class="attendance-btn present" onclick="markAttendance(this, 'present')">present</button>
          <button class="attendance-btn absent" onclick="markAttendance(this, 'absent')">absent</button>
          <span class="marking-status"><span class="tick">‚úì</span>marked</span>
        </div>
      </div>
      <div class="subject-card" data-subject="subject-4">
        <h3 class="subject-title" onclick="editSubjectName(this)">subject 4</h3>
        <div class="subject-stats">
          <div class="stat-item">
            <span class="stat-label">attended:</span>
            <span class="attended">0</span>
            <button class="edit-btn" onclick="openNumberPicker(this, 'attended')">‚úé</button>
          </div>
          <div class="stat-item">
            <span class="stat-label">total:</span>
            <span class="total">0</span>
            <button class="edit-btn" onclick="openNumberPicker(this, 'total')">‚úé</button>
          </div>
          <div class="subject-progress progress-circle">
            <canvas class="subject-chart"></canvas>
            <span class="progress-value">0%</span>
          </div>
        </div>
        <div class="attendance-controls">
          <button class="attendance-btn present" onclick="markAttendance(this, 'present')">present</button>
          <button class="attendance-btn absent" onclick="markAttendance(this, 'absent')">absent</button>
          <span class="marking-status"><span class="tick">‚úì</span>marked</span>
        </div>
      </div>
      <div class="subject-card" data-subject="subject-5">
        <h3 class="subject-title" onclick="editSubjectName(this)">subject 5</h3>
        <div class="subject-stats">
          <div class="stat-item">
            <span class="stat-label">attended:</span>
            <span class="attended">0</span>
            <button class="edit-btn" onclick="openNumberPicker(this, 'attended')">‚úé</button>
          </div>
          <div class="stat-item">
            <span class="stat-label">total:</span>
            <span class="total">0</span>
            <button class="edit-btn" onclick="openNumberPicker(this, 'total')">‚úé</button>
          </div>
          <div class="subject-progress progress-circle">
            <canvas class="subject-chart"></canvas>
            <span class="progress-value">0%</span>
          </div>
        </div>
        <div class="attendance-controls">
          <button class="attendance-btn present" onclick="markAttendance(this, 'present')">present</button>
          <button class="attendance-btn absent" onclick="markAttendance(this, 'absent')">absent</button>
          <span class="marking-status"><span class="tick">‚úì</span>marked</span>
        </div>
      </div>
    </div>
    <!-- Medical Section --> 
    <div class="medical-section">
      <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 10px;">
        <button class="save-btn" onclick="saveCurrentAsBaseline()">üîí save</button>
        <button class="reset-btn" onclick="resetTodayAttendance()">‚Ü∫ undo</button>
        <button class="medical-toggle-btn">show medical dates</button>
      </div>
      <div class="medical-dates-container" style="display: none;">
        <div class="medical-input">
          <input type="date" id="medicalDateInput" />
          <button onclick="addPastMedicalDate()">add past date</button>
        </div>
        <p id="medicalAttendanceMessage">after submitting medicals, your attendance would be: 0% (assuming that all 5 lectures were conducted on those days)</p>
        <div class="medical-dates">
          <ul id="medicalDatesList"></ul>
        </div>
      </div>
      <div class="footer">
        <p class="note">note: subjects can be renamed by tapping on them.</p>
        <p class="note">install this as an app on iOS by clicking on the "Share" button and then the "Add to homescreen" button.</p>
        <p class="developer">developed by @umarxshaikh</p>
      </div>
    </div>
  </div>
  
  <!-- Number Picker Modal -->
  <div id="numberPickerModal" class="modal">
    <div class="modal-content">
      <input type="number" id="numberPickerInput" min="0" max="999" />
      <div style="text-align: right;">
        <button class="cancel-btn" onclick="closeNumberPicker()">cancel</button>
        <button class="ok-btn" onclick="applyNumberPicker()">confirm</button>
      </div>
    </div>
  </div>
  
  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content settings-content">
      <div class="settings-header">
        <span class="settings-title">settings</span>
        <button class="close-settings-btn" onclick="closeSettingsModal()">&#10005;</button>
      </div>
      <div class="settings-section">
        <div class="settings-section-row">
          <h4 class="settings-section-title">number of subjects:</h4>
          <button class="apply-btn section-action-btn" onclick="applySubjectCount()">apply changes</button>
        </div>
        <div class="subject-control">
          <button class="control-btn" onclick="decreaseSubjects(event)">-</button>
          <span id="subjectCount">5</span>
          <button class="control-btn" onclick="increaseSubjects(event)">+</button>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-row">
          <h4 class="settings-section-title">reset all data?</h4>
          <button class="reset-all-btn section-action-btn" onclick="confirmResetAll()">reset everything</button>
        </div>
        <p class="warning-text">WARNING: this will delete all attendance data and cannot be undone.</p>
      </div>
    </div>
  </div>
  
  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content confirm-content">
      <h3>Confirm Reset</h3>
      <p>are you sure you want to reset all data? this action cannot be undone.</p>
      <div class="confirm-buttons">
        <button class="cancel-btn" onclick="closeConfirmModal()">cancel</button>
        <button class="confirm-btn" onclick="resetAllData()">reset everything</button>
      </div>
    </div>
  </div>
  
  <!-- Apply Changes Confirmation Modal -->
  <div id="applyConfirmModal" class="modal">
    <div class="modal-content confirm-content">
      <h3>Confirm Changes</h3>
      <p>Are you sure you want to change the number of subjects? This may remove data for deleted subjects.</p>
      <div class="confirm-buttons">
        <button class="cancel-btn" onclick="closeApplyConfirmModal()">cancel</button>
        <button class="apply-btn" onclick="confirmApplySubjectCount()">apply</button>
      </div>
    </div>
  </div>
  
  <!-- Manifest (inline for offline support) -->
  <script type="application/manifest+json" id="inline-manifest">
    {
      "name": "TallyCat",
      "short_name": "TallyCat",
      "start_url": ".",
      "display": "standalone",
      "background_color": "#1a1a1a",
      "theme_color": "#1a1a1a",
      "icons": [
        { "src": "catto.ico", "sizes": "192x192", "type": "image/png" }
      ]
    }
  </script>
  <meta name="theme-color" content="#1a1a1a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TallyCat">
  <link rel="apple-touch-icon" href="catto.ico">
  <script>
    let overallChart;
    const subjectCharts = {};
    let currentEditElement = null;
    let currentEditType = '';
    
    window.onload = function() {
      initializeCharts();
      loadData();
      setBaselineAttendanceData();
      checkAndResetMarkings();
      setInterval(() => {
        const now = new Date();
        if (now.getHours() === 0 && now.getMinutes() === 0) {
          document.querySelectorAll('.marking-status').forEach(status => status.classList.remove('visible'));
          localStorage.removeItem('markingTimestamps');
        }
      }, 60000);
    };
    
    function initializeCharts() {
      const chartOptions = {
        type: 'doughnut',
        data: {
          datasets: [{
            data: [0, 100],
            backgroundColor: ['#22c55e', '#27272a'],
            borderWidth: 0
          }]
        },
        options: {
          cutout: '80%',
          responsive: true,
          maintainAspectRatio: true,
          plugins: { legend: { display: false }, tooltip: { enabled: false } }
        }
      };
      const overallCtx = document.getElementById('overallChart').getContext('2d');
      overallChart = new Chart(overallCtx, chartOptions);
      document.querySelectorAll('.subject-chart').forEach(canvas => {
        const ctx = canvas.getContext('2d');
        const subject = canvas.closest('.subject-card').dataset.subject;
        subjectCharts[subject] = new Chart(ctx, chartOptions);
      });
    }
    
    function markAttendance(btn, status) {
      handleTap(btn, function() {
        const card = btn.closest('.subject-card');
        const attended = card.querySelector('.attended');
        const total = card.querySelector('.total');
        if (status === 'present') {
          attended.textContent = parseInt(attended.textContent) + 1;
        }
        total.textContent = parseInt(total.textContent) + 1;
        updatePercentages(card);
        showMarkingStatus(card);
      });
    }
    
    function updatePercentages(card) {
      const attended = parseInt(card.querySelector('.attended').textContent);
      const total = parseInt(card.querySelector('.total').textContent);
      const percentage = total > 0 ? (attended / total * 100).toFixed(0) : 0;
      card.querySelector('.progress-value').textContent = `${percentage}%`;
      const subject = card.dataset.subject;
      updateSubjectChart(subject, percentage);
      updateOverallAttendance();
      saveData();
    }
    
    function updateSubjectChart(subject, percentage) {
      const chart = subjectCharts[subject];
      chart.data.datasets[0].data = [percentage, 100 - percentage];
      chart.data.datasets[0].backgroundColor = [
        percentage >= 75 ? '#22c55e' : percentage >= 55 ? '#eab308' : '#ef4444',
        '#27272a'
      ];
      chart.update();
    }
    
    function updateOverallAttendance() {
      let totalAttended = 0;
      let totalLectures = 0;
      document.querySelectorAll('.subject-card').forEach(card => {
        totalAttended += parseInt(card.querySelector('.attended').textContent);
        totalLectures += parseInt(card.querySelector('.total').textContent);
      });
      let p = totalLectures > 0 ? totalAttended / totalLectures * 100 : 0;
      let overallPercentage = totalLectures > 0 ? p.toFixed(0) : 0;
      overallChart.data.datasets[0].data = [overallPercentage, 100 - overallPercentage];
      overallChart.data.datasets[0].backgroundColor = [
        overallPercentage >= 75 ? '#22c55e' : overallPercentage >= 55 ? '#eab308' : '#ef4444',
        '#27272a'
      ];
      overallChart.update();
      document.querySelector('.overall-progress .progress-value').textContent = `${overallPercentage}%`;
      document.getElementById('totalLectures').textContent = `total lectures: ${totalLectures}`;
      document.getElementById('totalAttended').textContent = `total attended: ${totalAttended}`;
      updateAttendanceHint(totalAttended, totalLectures);
      updateMedicalAttendanceMessage();
    }
    
    function updateAttendanceHint(totalAttended, totalLectures) {
      let hintText = "";
      if (totalLectures === 0) {
        hintText = "";
      } else {
        let p = totalAttended / totalLectures * 100;
        if (p > 75) {
          let canMiss = Math.floor(totalAttended / 0.75 - totalLectures);
          hintText = `you can skip ${canMiss} more lecture${canMiss === 1 ? '' : 's'} before falling under 75%.`;
        } else if (p >= 55) {
          let needAttend = Math.ceil(3 * totalLectures - 4 * totalAttended);
          if (needAttend < 0) needAttend = 0;
          hintText = `you need to attend ${needAttend} more lecture${needAttend === 1 ? '' : 's'} to reach 75%.`;
        } else {
          let needAttend = Math.ceil((0.55 * totalLectures - totalAttended) / 0.45);
          if (needAttend < 0) needAttend = 0;
          hintText = `you need to attend ${needAttend} more lecture${needAttend === 1 ? '' : 's'} to reach 55%.`;
        }
      }
      document.getElementById('attendanceHint').textContent = hintText;
    }
    
    function markAllPresent() {
      document.querySelectorAll('.subject-card').forEach(card => {
        const attended = card.querySelector('.attended');
        const total = card.querySelector('.total');
        attended.textContent = parseInt(attended.textContent) + 1;
        total.textContent = parseInt(total.textContent) + 1;
        updatePercentages(card);
        showMarkingStatus(card);
      });
    }
    
    function markAllAbsent() {
      document.querySelectorAll('.subject-card').forEach(card => {
        const total = card.querySelector('.total');
        total.textContent = parseInt(total.textContent) + 1;
        updatePercentages(card);
        showMarkingStatus(card);
      });
    }
    
    function markMedical() {
      const todayStr = new Date().toISOString().split('T')[0];
      addMedicalDate(todayStr);
    }
    
    function editSubjectName(element) {
      const currentName = element.textContent;
      const newName = prompt('Enter new subject name:', currentName);
      if (newName && newName.trim() !== '') {
        element.textContent = newName.trim();
        saveData();
      }
      event.stopPropagation();
    }
    
    function saveData() {
      const data = {};
      document.querySelectorAll('.subject-card').forEach(card => {
        const subject = card.dataset.subject;
        data[subject] = {
          name: card.querySelector('.subject-title').textContent,
          attended: card.querySelector('.attended').textContent,
          total: card.querySelector('.total').textContent
        };
      });
      localStorage.setItem('attendanceData', JSON.stringify(data));
    }
    
    function saveMedicalDates() {
      const dates = Array.from(document.querySelectorAll('#medicalDatesList li'))
        .map(li => li.getAttribute('data-date'));
      localStorage.setItem('medicalDates', JSON.stringify(dates));
    }
    
    function addMedicalDate(dateStr) {
      const exists = Array.from(document.querySelectorAll('#medicalDatesList li'))
        .some(li => li.getAttribute('data-date') === dateStr);
      if (exists) {
        alert("This date has already been added.");
        return;
      }
      const list = document.getElementById('medicalDatesList');
      const li = document.createElement('li');
      li.setAttribute('data-date', dateStr);
      const dateSpan = document.createElement('span');
      dateSpan.textContent = new Date(dateStr).toLocaleDateString();
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = '√ó';
      deleteBtn.className = 'delete-date';
      deleteBtn.onclick = function() {
        li.remove();
        saveMedicalDates();
        updateMedicalAttendanceMessage();
      };
      li.appendChild(dateSpan);
      li.appendChild(deleteBtn);
      list.appendChild(li);
      saveMedicalDates();
      updateMedicalAttendanceMessage();
    }
    
    function addPastMedicalDate() {
      const dateInput = document.getElementById('medicalDateInput');
      if (!dateInput.value) {
        alert("Please select a date");
        return;
      }
      addMedicalDate(dateInput.value);
      dateInput.value = "";
    }
    
    function updateMedicalAttendanceMessage() {
      let totalAttended = 0;
      let totalLectures = 0;
      document.querySelectorAll('.subject-card').forEach(card => {
        totalAttended += parseInt(card.querySelector('.attended').textContent);
        totalLectures += parseInt(card.querySelector('.total').textContent);
      });
      let numberOfSubjects = document.querySelectorAll('.subject-card').length;
      const medicalDatesCount = document.querySelectorAll('#medicalDatesList li').length;
      let newAttendance = 0;
      if (totalLectures > 0) {
        newAttendance = ((totalAttended + numberOfSubjects * medicalDatesCount) / totalLectures * 100).toFixed(0);
      }
      document.getElementById('medicalAttendanceMessage').textContent =
        `after submitting medicals, your attendance would be: ${newAttendance}% (assuming that all lectures were conducted on those days)`;
    }
    
    document.querySelector('.medical-toggle-btn').addEventListener('click', function() {
      const container = document.querySelector('.medical-dates-container');
      const isHidden = container.style.display === 'none';
      container.style.display = isHidden ? 'block' : 'none';
      this.textContent = isHidden ? 'hide medical dates' : 'show medical dates';
    });
    
    function isToday(date) {
      const today = new Date();
      return date.getDate() === today.getDate() &&
             date.getMonth() === today.getMonth() &&
             date.getFullYear() === today.getFullYear();
    }
    
    function showMarkingStatus(card) {
      const markingStatus = card.querySelector('.marking-status');
      markingStatus.classList.add('visible');
      const subject = card.dataset.subject;
      const markings = JSON.parse(localStorage.getItem('markingTimestamps') || '{}');
      markings[subject] = new Date().toISOString();
      localStorage.setItem('markingTimestamps', JSON.stringify(markings));
    }
    
    function checkAndResetMarkings() {
      const markings = JSON.parse(localStorage.getItem('markingTimestamps') || '{}');
      Object.entries(markings).forEach(([subject, timestamp]) => {
        const date = new Date(timestamp);
        const card = document.querySelector(`[data-subject="${subject}"]`);
        const markingStatus = card ? card.querySelector('.marking-status') : null;
        if (markingStatus && isToday(date)) {
          markingStatus.classList.add('visible');
        } else {
          markingStatus && markingStatus.classList.remove('visible');
        }
      });
    }
    
    function setBaselineAttendanceData() {
      const today = new Date().toISOString().split('T')[0];
      const storedBaseline = localStorage.getItem('baselineAttendanceData');
      if (storedBaseline) {
        const baselineData = JSON.parse(storedBaseline);
        if (baselineData.date === today) return;
      }
      const baselineData = { date: today, subjects: {} };
      document.querySelectorAll('.subject-card').forEach(card => {
        const subject = card.dataset.subject;
        baselineData.subjects[subject] = {
          attended: parseInt(card.querySelector('.attended').textContent),
          total: parseInt(card.querySelector('.total').textContent)
        };
      });
      localStorage.setItem('baselineAttendanceData', JSON.stringify(baselineData));
    }
    
    function resetTodayAttendance() {
      const baselineDataStr = localStorage.getItem('baselineAttendanceData');
      if (!baselineDataStr) {
        alert("No baseline data found.");
        return;
      }
      const baselineData = JSON.parse(baselineDataStr);
      const today = new Date().toISOString().split('T')[0];
      if (baselineData.date !== today) {
        alert("Baseline data is not for today.");
        return;
      }
      document.querySelectorAll('.subject-card').forEach(card => {
        const subject = card.dataset.subject;
        if (baselineData.subjects[subject]) {
          card.querySelector('.attended').textContent = baselineData.subjects[subject].attended;
          card.querySelector('.total').textContent = baselineData.subjects[subject].total;
          updatePercentages(card);
        }
      });
      document.querySelectorAll('.marking-status').forEach(status => {
        status.classList.remove('visible');
      });
      localStorage.removeItem('markingTimestamps');
      alert("attendance for today has been reset to baseline");
    }
    
    function loadData() {
      const savedData = localStorage.getItem('attendanceData');
      if (savedData) {
        const data = JSON.parse(savedData);
        Object.entries(data).forEach(([subject, values]) => {
          const card = document.querySelector(`[data-subject="${subject}"]`);
          if (card) {
            card.querySelector('.subject-title').textContent = values.name;
            card.querySelector('.attended').textContent = values.attended;
            card.querySelector('.total').textContent = values.total;
            updatePercentages(card);
          }
        });
      }
      const savedDates = localStorage.getItem('medicalDates');
      if (savedDates) {
        const dates = JSON.parse(savedDates);
        const list = document.getElementById('medicalDatesList');
        dates.forEach(dateStr => {
          const li = document.createElement('li');
          li.setAttribute('data-date', dateStr);
          const dateSpan = document.createElement('span');
          dateSpan.textContent = new Date(dateStr).toLocaleDateString();
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = '√ó';
          deleteBtn.className = 'delete-date';
          deleteBtn.onclick = function() {
            li.remove();
            saveMedicalDates();
            updateMedicalAttendanceMessage();
          };
          li.appendChild(dateSpan);
          li.appendChild(deleteBtn);
          list.appendChild(li);
        });
      }
      updateMedicalAttendanceMessage();
    }
    
    function openNumberPicker(btn, type) {
      currentEditType = type;
      const statItem = btn.parentElement;
      currentEditElement = statItem.querySelector('.' + type);
      const currentValue = parseInt(currentEditElement.textContent);
      document.getElementById('numberPickerInput').value = currentValue;
      document.getElementById('numberPickerModal').style.display = 'flex';
      event.stopPropagation();
    }
    
    function closeNumberPicker() {
      document.getElementById('numberPickerModal').style.display = 'none';
      currentEditElement = null;
      currentEditType = '';
    }
    
    function applyNumberPicker() {
      const newValue = parseInt(document.getElementById('numberPickerInput').value);
      if (isNaN(newValue) || newValue < 0) {
        alert("Please enter a valid non-negative number");
        return;
      }
      currentEditElement.textContent = newValue;
      const card = currentEditElement.closest('.subject-card');
      if (currentEditType === 'attended') {
        const totalElement = card.querySelector('.total');
        const currentTotal = parseInt(totalElement.textContent);
        if (newValue > currentTotal) {
          totalElement.textContent = newValue;
        }
      } else if (currentEditType === 'total') {
        const attendedElement = card.querySelector('.attended');
        const currentAttended = parseInt(attendedElement.textContent);
        if (newValue < currentAttended) {
          attendedElement.textContent = newValue;
        }
      }
      updatePercentages(card);
      closeNumberPicker();
    }
    
    window.onclick = function(event) {
      const modal = document.getElementById('numberPickerModal');
      if (event.target === modal) {
        closeNumberPicker();
      }
    };
    
    function handleTap(button, callback) {
      button.disabled = true;
      callback();
      setTimeout(() => { button.disabled = false; }, 300);
    }
    
    function saveCurrentAsBaseline() {
      const baselineData = { date: new Date().toISOString().split('T')[0], subjects: {} };
      document.querySelectorAll('.subject-card').forEach(card => {
        const subject = card.dataset.subject;
        baselineData.subjects[subject] = {
          attended: parseInt(card.querySelector('.attended').textContent),
          total: parseInt(card.querySelector('.total').textContent)
        };
      });
      localStorage.setItem('baselineAttendanceData', JSON.stringify(baselineData));
      alert("current attendance saved as baseline");
    }
    
    // SETTINGS FUNCTIONALITY
    document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);
    
    function openSettingsModal() {
      document.getElementById('subjectCount').textContent = document.querySelectorAll('.subject-card').length;
      document.getElementById('settingsModal').style.display = 'flex';
      updateApplyBtnState();
    }
    
    function closeSettingsModal() {
      document.getElementById('settingsModal').style.display = 'none';
    }
    
    function updateApplyBtnState() {
      const newCount = parseInt(document.getElementById('subjectCount').textContent);
      const currentCount = document.querySelectorAll('.subject-card').length;
      const applyBtn = document.querySelector('.apply-btn.section-action-btn');
      if (applyBtn) {
        if (newCount === currentCount) {
          applyBtn.classList.add('disabled');
          applyBtn.disabled = true;
        } else {
          applyBtn.classList.remove('disabled');
          applyBtn.disabled = false;
        }
      }
    }
    
    function increaseSubjects(event) {
      event.stopPropagation();
      let count = parseInt(document.getElementById('subjectCount').textContent);
      document.getElementById('subjectCount').textContent = count + 1;
      updateApplyBtnState();
    }
    
    function decreaseSubjects(event) {
      event.stopPropagation();
      let count = parseInt(document.getElementById('subjectCount').textContent);
      if (count > 1) {
        document.getElementById('subjectCount').textContent = count - 1;
        updateApplyBtnState();
      }
    }
    
    function showApplyConfirmModal() {
      document.getElementById('applyConfirmModal').style.display = 'flex';
    }
    
    function closeApplyConfirmModal() {
      document.getElementById('applyConfirmModal').style.display = 'none';
    }
    
    function confirmApplySubjectCount() {
      closeApplyConfirmModal();
      actuallyApplySubjectCount();
    }
    
    function applySubjectCount(fromConfirm) {
      if (!fromConfirm) {
        showApplyConfirmModal();
        return;
      }
      actuallyApplySubjectCount();
    }
    
    function actuallyApplySubjectCount() {
      const newCount = parseInt(document.getElementById('subjectCount').textContent);
      const currentCount = document.querySelectorAll('.subject-card').length;
      if (newCount === currentCount) {
        closeSettingsModal();
        return;
      }
      if (newCount < currentCount) {
        const subjects = document.querySelectorAll('.subject-card');
        for (let i = currentCount - 1; i >= newCount; i--) {
          subjects[i].remove();
        }
      } else {
        const subjectsContainer = document.querySelector('.subjects');
        const templateCard = document.querySelector('.subject-card').cloneNode(true);
        for (let i = currentCount; i < newCount; i++) {
          const newCard = templateCard.cloneNode(true);
          const subjectName = `subject ${i + 1}`;
          newCard.dataset.subject = subjectName.replace(/\s+/g, '-');
          newCard.querySelector('.subject-title').textContent = subjectName;
          newCard.querySelector('.attended').textContent = '0';
          newCard.querySelector('.total').textContent = '0';
          const canvas = newCard.querySelector('.subject-chart');
          canvas.id = `chart-${i}`;
          newCard.querySelector('.subject-title').onclick = function() { editSubjectName(this); };
          newCard.querySelector('.edit-btn[onclick*="attended"]').onclick = function() { openNumberPicker(this, 'attended'); };
          newCard.querySelector('.edit-btn[onclick*="total"]').onclick = function() { openNumberPicker(this, 'total'); };
          newCard.querySelector('.attendance-btn.present').onclick = function() { markAttendance(this, 'present'); };
          newCard.querySelector('.attendance-btn.absent').onclick = function() { markAttendance(this, 'absent'); };
          subjectsContainer.appendChild(newCard);
          const ctx = canvas.getContext('2d');
          const chartOptions = {
            type: 'doughnut',
            data: {
              datasets: [{
                data: [0, 100],
                backgroundColor: ['#22c55e', '#27272a'],
                borderWidth: 0
              }]
            },
            options: {
              cutout: '80%',
              responsive: true,
              maintainAspectRatio: true,
              plugins: { legend: { display: false }, tooltip: { enabled: false } }
            }
          };
          subjectCharts[newCard.dataset.subject] = new Chart(ctx, chartOptions);
        }
      }
      saveData();
      updateOverallAttendance();
      closeSettingsModal();
    }
    
    function confirmResetAll() {
      closeSettingsModal();
      document.getElementById('confirmModal').style.display = 'flex';
    }
    
    function closeConfirmModal() {
      document.getElementById('confirmModal').style.display = 'none';
    }
    
    function resetAllData() {
      localStorage.removeItem('attendanceData');
      localStorage.removeItem('medicalDates');
      localStorage.removeItem('markingTimestamps');
      localStorage.removeItem('baselineAttendanceData');
      document.querySelectorAll('.subject-card').forEach(card => {
        card.querySelector('.attended').textContent = '0';
        card.querySelector('.total').textContent = '0';
        updatePercentages(card);
      });
      document.getElementById('medicalDatesList').innerHTML = '';
      document.querySelectorAll('.marking-status').forEach(status => {
        status.classList.remove('visible');
      });
      setBaselineAttendanceData();
      closeConfirmModal();
      alert("All data has been reset successfully");
    }
    
    const numberOfSubjects = document.querySelectorAll('.subject-card').length;
    console.log("Number of subjects:", numberOfSubjects);
    console.log("Optimized and loaded");
  </script>
  <!-- Service Worker registration and inline service worker code for offline support -->
  <script>
    // Inline manifest injection for browsers that expect a manifest.json file
    (function() {
      var manifestTag = document.getElementById('inline-manifest');
      if (manifestTag) {
        var manifestContent = manifestTag.textContent;
        var blob = new Blob([manifestContent], {type: 'application/json'});
        var manifestURL = URL.createObjectURL(blob);
        var link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);
      }
    })();

    // Service Worker registration and inline code
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        // Inline service worker code as a blob
        var swCode = `
          const CACHE_NAME = 'tallycat-cache-v1';
          const urlsToCache = [
            '/',
            '/index2.html',
            '/catto.ico',
            'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js'
          ];
          self.addEventListener('install', event => {
            event.waitUntil(
              caches.open(CACHE_NAME)
                .then(cache => cache.addAll(urlsToCache))
            );
          });
          self.addEventListener('activate', event => {
            event.waitUntil(
              caches.keys().then(keys =>
                Promise.all(
                  keys.filter(key => key !== CACHE_NAME)
                      .map(key => caches.delete(key))
                )
              )
            );
          });
          self.addEventListener('fetch', event => {
            event.respondWith(
              caches.match(event.request)
                .then(response => response || fetch(event.request))
            );
          });
        `;
        var blob = new Blob([swCode], {type: 'application/javascript'});
        var swUrl = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swUrl)
          .then(function(reg) {
            console.log('Service worker registered.', reg);
          });
      });
    }
  </script>
</body>
</html>
